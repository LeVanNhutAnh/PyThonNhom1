<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech to Text AI Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .controls-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 25px;
            background: #e9ecef;
        }

        .status-indicator.listening {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .status-indicator.processing {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
        }

        .language-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .language-selector select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .text-areas {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            align-items: start;
        }

        .ai-section {
            grid-column: 1 / -1;
            width: 100%;
        }

        .text-area-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .text-area-container h3 {
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .text-area {
            width: 100%;
            min-height: 250px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s ease;
            flex: 1;
        }

        .text-area:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .ai-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }

        .ai-section h3 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .ai-response {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            min-height: 150px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-card i {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .word-count {
            font-size: 14px;
            color: #6c757d;
            margin-top: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Markdown Content Styling */
        .markdown-content {
            line-height: 1.8;
            color: #e0e0e0;
        }

        .markdown-content h1 {
            font-size: 2em;
            font-weight: bold;
            color: #4fc3f7;
            margin: 1.2em 0 0.6em 0;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 0.3em;
        }

        .markdown-content h2 {
            font-size: 1.75em;
            font-weight: bold;
            color: #4fc3f7;
            margin: 1em 0 0.5em 0;
            border-bottom: 1px solid #4fc3f7;
            padding-bottom: 0.3em;
        }

        .markdown-content h3 {
            font-size: 1.5em;
            font-weight: bold;
            color: #64b5f6;
            margin: 0.9em 0 0.4em 0;
        }

        .markdown-content h4 {
            font-size: 1.3em;
            font-weight: bold;
            color: #64b5f6;
            margin: 0.8em 0 0.4em 0;
        }

        .markdown-content h5 {
            font-size: 1.1em;
            font-weight: bold;
            color: #90caf9;
            margin: 0.7em 0 0.3em 0;
        }

        .markdown-content h6 {
            font-size: 1em;
            font-weight: bold;
            color: #90caf9;
            margin: 0.6em 0 0.3em 0;
        }

        .markdown-content p {
            margin: 0.8em 0;
        }

        .markdown-content strong,
        .markdown-content b {
            color: #ffeb3b;
            font-weight: bold;
        }

        .markdown-content em,
        .markdown-content i {
            color: #81c784;
            font-style: italic;
        }

        .markdown-content hr {
            border: none;
            border-top: 2px solid #4fc3f7;
            margin: 1.5em 0;
            opacity: 0.5;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }

        .markdown-content li {
            margin: 0.5em 0;
        }

        .markdown-content ul li {
            list-style-type: disc;
        }

        .markdown-content ol li {
            list-style-type: decimal;
        }

        .markdown-content blockquote {
            border-left: 4px solid #4fc3f7;
            padding-left: 1em;
            margin: 1em 0;
            color: #b0bec5;
            font-style: italic;
        }

        .markdown-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #f48fb1;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background: rgba(255, 255, 255, 0.05);
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
            margin: 1em 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
            color: #e0e0e0;
            font-size: 0.95em;
        }

        .markdown-content a {
            color: #4fc3f7;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.3s;
        }

        .markdown-content a:hover {
            border-bottom-color: #4fc3f7;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.6em;
            text-align: left;
        }

        .markdown-content th {
            background: rgba(79, 195, 247, 0.2);
            font-weight: bold;
        }

        .markdown-content tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        /* History Item Styles */
        .history-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-item-time {
            font-size: 0.85em;
            color: #6c757d;
        }

        .history-item-type {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .history-item-question {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-wrap: break-word;
        }

        .history-item-answer {
            color: #6c757d;
            font-size: 0.9em;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .history-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .history-item-actions button {
            background: white;
            border: 1px solid #dee2e6;
            color: #6c757d;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .history-item-actions button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .text-areas {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-microphone"></i> Speech to Text AI Assistant</h1>
            <p>Chuyển đổi giọng nói thành văn bản và tương tác với AI thông minh</p>
        </div>

        <div class="main-content">
            <!-- Control Panel -->
            <div class="controls-panel">
                <div class="control-group">
                    <button id="startBtn" class="btn btn-success">
                        <i class="fas fa-microphone"></i>
                        Bắt đầu ghi âm
                    </button>
                    <button id="stopBtn" class="btn btn-danger" disabled>
                        <i class="fas fa-stop"></i>
                        Dừng ghi âm
                    </button>
                    <button id="clearBtn" class="btn btn-warning">
                        <i class="fas fa-trash"></i>
                        Xóa tất cả
                    </button>
                    <button id="historyBtn" class="btn btn-primary" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-history"></i>
                        Lịch sử
                    </button>
                    <button id="settingsBtn" class="btn btn-primary">
                        <i class="fas fa-cog"></i>
                        Cài đặt
                    </button>
                </div>

                <div class="control-group">
                    <div class="language-selector">
                        <label for="speechEngine"><i class="fas fa-microphone"></i> Engine:</label>
                        <select id="speechEngine">
                            <option value="browser">Web Speech API (Miễn phí)</option>
                            <option value="whisper">OpenAI Whisper (Trả phí - Chất lượng cao)</option>
                        </select>
                    </div>
                    
                    <div class="language-selector">
                        <label for="languageSelect"><i class="fas fa-language"></i> Ngôn ngữ:</label>
                        <select id="languageSelect">
                            <option value="vi">Tiếng Việt</option>
                            <option value="en">English</option>
                            <option value="ja">日本語</option>
                            <option value="ko">한국어</option>
                            <option value="zh">中文</option>
                            <option value="fr">Français</option>
                            <option value="de">Deutsch</option>
                            <option value="es">Español</option>
                        </select>
                    </div>
                    
                    <div class="status-indicator" id="statusIndicator">
                        <i class="fas fa-circle"></i>
                        <span>Sẵn sàng</span>
                    </div>
                </div>
            </div>

            <!-- Text Areas -->
            <div class="text-areas">
                <!-- Column 1: Transcript -->
                <div class="text-area-container">
                    <h3><i class="fas fa-microphone-alt"></i> Văn bản đã chuyển đổi</h3>
                    <textarea id="transcriptArea" class="text-area" placeholder="Văn bản sẽ xuất hiện ở đây khi bạn nói..."></textarea>
                    <div class="stats-panel" style="display: flex; gap: 20px; margin-top: 10px; font-size: 14px; color: #6c757d;">
                        <div class="word-count" id="wordCount">0 từ</div>
                        <div id="charCount">0 ký tự</div>
                        <div id="speechTime">Thời gian: 0s</div>
                        <div id="wpm">0 từ/phút</div>
                    </div>
                </div>

                <!-- Column 2: Edit Area -->
                <div class="text-area-container">
                    <h3><i class="fas fa-edit"></i> Chỉnh sửa văn bản</h3>
                    <textarea id="editArea" class="text-area" placeholder="Bạn có thể chỉnh sửa văn bản ở đây..."></textarea>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="copyBtn">
                            <i class="fas fa-copy"></i>
                            Sao chép
                        </button>
                        <button class="btn btn-success" id="saveFileBtn">
                            <i class="fas fa-save"></i>
                            Lưu file
                        </button>
                        <button class="btn btn-info" id="shareBtn">
                            <i class="fas fa-share-alt"></i>
                            Chia sẻ
                        </button>
                    </div>
                </div>

                <!-- AI Assistant Section (FULL WIDTH BELOW) -->
                <div class="text-area-container ai-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h3 style="color: white;"><i class="fas fa-robot"></i> Trợ lý AI thông minh</h3>
                    
                    <!-- AI Action Buttons (includes upload) -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <!-- File Upload Buttons (inline with others) -->
                        <button class="btn btn-primary" id="selectFileBtn" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white;">
                            <i class="fas fa-folder-open"></i>
                            <span id="fileButtonLabel">Chọn file</span>
                        </button>
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx" style="display: none;">
                        
                        <button class="btn btn-success" id="analyzeFileBtn" disabled style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white; opacity: 0.5;">
                            <i class="fas fa-search"></i>
                            Phân tích file
                        </button>
                        
                        <!-- Divider -->
                        <div style="width: 1px; background: rgba(255,255,255,0.3); align-self: stretch;"></div>
                        
                        <!-- Text AI Buttons -->
                        <button class="btn btn-primary" id="sendToAI" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white;">
                            <i class="fas fa-paper-plane"></i>
                            Gửi cho AI
                        </button>
                        <button class="btn btn-primary" id="summarizeBtn" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white;">
                            <i class="fas fa-compress-alt"></i>
                            Tóm tắt
                        </button>
                        <button class="btn btn-primary" id="improveBtn" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white;">
                            <i class="fas fa-magic"></i>
                            Cải thiện
                        </button>
                        <button class="btn btn-primary" id="translateBtn" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white;">
                            <i class="fas fa-language"></i>
                            Dịch Anh
                        </button>
                        <button class="btn btn-primary" id="aiPunctuationBtn" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white;">
                            <i class="fas fa-robot"></i>
                            Sửa chấm câu
                        </button>
                    </div>

                    <!-- File Info (compact, below buttons) -->
                    <div id="fileInfo" style="background: rgba(255,255,255,0.1); border-radius: 5px; padding: 6px 10px; margin-bottom: 10px; display: none; font-size: 0.85em; border-left: 3px solid #4fc3f7; display: flex; align-items: center; justify-content: space-between;">
                        <p style="margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">
                            <i class="fas fa-file"></i> <span id="fileName">-</span> 
                            <span style="opacity: 0.7; margin-left: 8px;">(<span id="fileSize">-</span>)</span>
                        </p>
                        <button id="clearFileBtn" style="background: transparent; border: none; color: white; cursor: pointer; padding: 4px 8px; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- AI Response Area -->
                    <div id="aiResponse" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; color: white; min-height: 150px; max-height: 300px; overflow-y: auto;">
                        <p><i class="fas fa-info-circle"></i> Kết quả từ AI sẽ hiển thị ở đây...</p>
                    </div>
                </div>
            </div>

            <!-- Features Grid -->
            <div class="features-grid">
                <div class="feature-card">
                    <i class="fas fa-microphone"></i>
                    <h4>Nhận dạng giọng nói</h4>
                    <p>Chuyển đổi giọng nói thành văn bản chính xác với hỗ trợ đa ngôn ngữ</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-robot"></i>
                    <h4>Tích hợp AI</h4>
                    <p>Gửi câu hỏi và nhận phản hồi thông minh từ trợ lý AI</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-language"></i>
                    <h4>Dịch thuật</h4>
                    <p>Dịch văn bản sang nhiều ngôn ngữ khác nhau một cách nhanh chóng</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-edit"></i>
                    <h4>Chỉnh sửa thông minh</h4>
                    <p>Cải thiện và tối ưu hóa văn bản với sự hỗ trợ của AI</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3><i class="fas fa-cog"></i> Cài đặt ứng dụng</h3>
            
            <div style="margin: 20px 0;">
                <label><strong>Chất lượng nhận dạng giọng nói:</strong></label>
                <select id="speechQuality" style="width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ddd;">
                    <option value="high">Cao (chậm hơn)</option>
                    <option value="medium" selected>Trung bình</option>
                    <option value="low">Nhanh (ít chính xác)</option>
                </select>
            </div>

            <div style="margin: 20px 0;">
                <label><strong>Tự động thêm dấu câu:</strong></label>
                <input type="checkbox" id="autoPunctuation" checked style="margin: 5px;">
                <span>Bật tự động thêm dấu câu</span>
            </div>

            <div style="margin: 20px 0;">
                <label><strong>Voice Commands:</strong></label>
                <input type="checkbox" id="voiceCommands" checked style="margin: 5px;">
                <span>Bật điều khiển bằng giọng nói</span>
            </div>

            <div style="margin: 20px 0;">
                <label><strong>AI Provider ưu tiên:</strong></label>
                <select id="aiProvider" style="width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ddd;">
                    <option value="gemini" selected>Google Gemini (Miễn phí)</option>
                    <option value="openai">OpenAI GPT (Trả phí)</option>
                    <option value="demo">Demo Mode</option>
                </select>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                <button class="btn btn-warning" onclick="closeSettings()">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button class="btn btn-success" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Lưu cài đặt
                </button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3><i class="fas fa-history"></i> Lịch sử trò chuyện với AI</h3>
                <button class="btn btn-warning" onclick="clearAllHistory()" style="padding: 8px 15px; min-width: auto;">
                    <i class="fas fa-trash"></i> Xóa tất cả
                </button>
            </div>
            
            <div id="historyContent" style="max-height: 500px; overflow-y: auto;">
                <div id="historyList" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- History items will be inserted here -->
                    <p style="text-align: center; color: #6c757d; padding: 40px;">
                        <i class="fas fa-inbox" style="font-size: 3em; display: block; margin-bottom: 10px; opacity: 0.3;"></i>
                        Chưa có lịch sử trò chuyện
                    </p>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-success" onclick="exportHistory()" style="padding: 10px 20px;">
                    <i class="fas fa-download"></i> Xuất file
                </button>
                <button class="btn btn-primary" onclick="closeHistory()">
                    <i class="fas fa-times"></i> Đóng
                </button>
            </div>
        </div>
    </div>

    <script>
        // Test if JavaScript is running
        console.log('=== JAVASCRIPT LOADED ===');
        
        class SpeechToTextApp {
            constructor() {
                console.log('Initializing SpeechToTextApp...');
                try {
                    this.recognition = null;
                    this.isListening = false;
                    this.transcript = '';
                    this.startTime = null;
                    this.mediaRecorder = null;
                    this.audioChunks = [];
                    this.currentEngine = 'browser';
                    
                    this.initElements();
                    this.initFileUpload();
                    this.initSpeechRecognition();
                    this.initHistory();
                    this.bindEvents();
                    
                    console.log('SpeechToTextApp initialized successfully!');
                } catch (error) {
                    console.error('Error initializing SpeechToTextApp:', error);
                    alert('Lỗi khởi tạo ứng dụng: ' + error.message);
                }
            }

            initElements() {
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.speechEngine = document.getElementById('speechEngine');
                this.languageSelect = document.getElementById('languageSelect');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.transcriptArea = document.getElementById('transcriptArea');
                this.editArea = document.getElementById('editArea');
                this.copyBtn = document.getElementById('copyBtn');
                this.wordCount = document.getElementById('wordCount');
                this.sendToAI = document.getElementById('sendToAI');
                this.translateBtn = document.getElementById('translateBtn');
                this.summarizeBtn = document.getElementById('summarizeBtn');
                this.improveBtn = document.getElementById('improveBtn');
                this.aiResponse = document.getElementById('aiResponse');
            }

            initFileUpload() {
                this.fileInput = document.getElementById('fileInput');
                this.selectFileBtn = document.getElementById('selectFileBtn');
                this.analyzeFileBtn = document.getElementById('analyzeFileBtn');
                this.clearFileBtn = document.getElementById('clearFileBtn');
                this.fileInfo = document.getElementById('fileInfo');
                this.currentFile = null;

                console.log('Initializing file upload...', {
                    fileInput: this.fileInput,
                    selectFileBtn: this.selectFileBtn,
                    analyzeBtn: this.analyzeFileBtn,
                    clearBtn: this.clearFileBtn
                });

                // Click button to trigger file input
                if (this.selectFileBtn && this.fileInput) {
                    this.selectFileBtn.addEventListener('click', () => {
                        console.log('Select file button clicked');
                        this.fileInput.click();
                    });
                }

                if (this.fileInput) {
                    this.fileInput.addEventListener('change', (e) => {
                        console.log('File input changed:', e.target.files);
                        this.handleFileSelect(e);
                    });
                    console.log('File input event listener added');
                } else {
                    console.error('File input element not found!');
                }
                
                if (this.analyzeFileBtn) {
                    this.analyzeFileBtn.addEventListener('click', () => this.analyzeDocument());
                }
                
                if (this.clearFileBtn) {
                    this.clearFileBtn.addEventListener('click', () => this.clearFile());
                }
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Kiểm tra loại file
                const allowedTypes = ['.pdf', '.doc', '.docx'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!allowedTypes.includes(fileExtension)) {
                    this.showNotification('Chỉ hỗ trợ file PDF, DOC và DOCX!', 'error');
                    this.fileInput.value = '';
                    return;
                }

                // Kiểm tra kích thước file (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    this.showNotification('File quá lớn! Vui lòng chọn file nhỏ hơn 10MB.', 'error');
                    this.fileInput.value = '';
                    return;
                }

                this.currentFile = file;
                this.displayFileInfo(file);
                
                console.log('Enabling analyze button...', this.analyzeFileBtn);
                if (this.analyzeFileBtn) {
                    this.analyzeFileBtn.disabled = false;
                    this.analyzeFileBtn.style.opacity = '1';
                    console.log('Analyze button enabled!');
                } else {
                    console.error('Analyze button not found!');
                }
            }

            displayFileInfo(file) {
                console.log('Displaying file info:', file);
                
                // Update button label
                const fileButtonLabel = document.getElementById('fileButtonLabel');
                if (fileButtonLabel) {
                    fileButtonLabel.textContent = file.name;
                    console.log('Button label updated');
                }
                
                // Update file info section (if exists)
                const fileName = document.getElementById('fileName');
                const fileSize = document.getElementById('fileSize');
                
                if (fileName) fileName.textContent = file.name;
                if (fileSize) fileSize.textContent = this.formatFileSize(file.size);
                
                if (this.fileInfo) {
                    this.fileInfo.style.display = 'block';
                }
                
                this.showNotification('File đã được chọn thành công!');
                console.log('File info displayed successfully');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async analyzeDocument() {
                console.log('=== ANALYZE DOCUMENT CLICKED ===');
                console.log('Current file:', this.currentFile);
                
                if (!this.currentFile) {
                    console.error('No file selected!');
                    this.showNotification('Vui lòng chọn file trước!', 'error');
                    return;
                }

                console.log('Starting analysis...');
                this.showFileAnalysisLoading();
                
                try {
                    // Tạo prompt phân tích dựa trên metadata của file
                    const fileInfo = `Tên file: ${this.currentFile.name}\nKích thước: ${this.formatFileSize(this.currentFile.size)}\nLoại: ${this.currentFile.type}`;
                    const prompt = `Phân tích thông tin về tài liệu này:\n\n${fileInfo}\n\nHãy đưa ra nhận xét về loại tài liệu và đề xuất cách sử dụng hiệu quả.`;

                    console.log('Sending to AI:', prompt);

                    // Gửi đến AI endpoint
                    const response = await fetch('/ai-chat/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        },
                        body: JSON.stringify({
                            message: prompt
                        })
                    });

                    console.log('Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('AI response:', data);
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    this.displayAnalysisResult(data);
                    this.showNotification('Phân tích tài liệu hoàn thành!');

                } catch (error) {
                    console.error('Document analysis error:', error);
                    this.showAnalysisError(error.message || 'Có lỗi xảy ra khi phân tích tài liệu');
                }
            }

            showFileAnalysisLoading() {
                // Display loading in AI response area
                if (this.aiResponse) {
                    this.aiResponse.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="loading"></div>
                            <span>Đang phân tích tài liệu, vui lòng chờ...</span>
                        </div>
                    `;
                }
            }

            displayAnalysisResult(data) {
                const aiResponse = data.response || data.message || 'Không có phản hồi từ AI';
                
                // Remove Markdown syntax characters
                const cleanText = this.removeMarkdownSyntax(aiResponse);
                
                // Display in main AI section
                if (this.aiResponse) {
                    this.aiResponse.innerHTML = `
                        <h4><i class="fas fa-file-alt"></i> Kết quả phân tích tài liệu:</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p><strong>File:</strong> ${this.currentFile ? this.currentFile.name : 'Không rõ'}</p>
                            <p><strong>Phân tích:</strong></p>
                            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin: 10px 0; line-height: 1.6; white-space: pre-wrap; max-height: 250px; overflow-y: auto;">
                                ${cleanText}
                            </div>
                            <p style="color: #90EE90; font-size: 0.9em; margin-top: 10px;">
                                <i class="fas fa-check-circle"></i> Phân tích hoàn tất!
                            </p>
                        </div>
                    `;
                    
                    // Show notification
                    this.showNotification('✅ Đã phân tích tài liệu và hiển thị kết quả!');
                }
            }

            removeMarkdownSyntax(text) {
                if (!text) return '';
                
                let cleaned = text;
                
                // STRATEGY: Remove ALL markdown characters using replace with global flag
                
                // 1. Remove ALL asterisks (** or * in any combination)
                cleaned = cleaned.replace(/\*\*/g, '');
                cleaned = cleaned.replace(/\*/g, '');
                
                // 2. Remove ALL hashtags
                cleaned = cleaned.replace(/###/g, '');
                cleaned = cleaned.replace(/##/g, '');
                cleaned = cleaned.replace(/#/g, '');
                
                // 3. Remove ALL underscores used for formatting
                cleaned = cleaned.replace(/__/g, '');
                cleaned = cleaned.replace(/_/g, '');
                
                // 4. Remove ALL backticks
                cleaned = cleaned.replace(/```/g, '');
                cleaned = cleaned.replace(/`/g, '');
                
                // 5. Remove ALL tildes
                cleaned = cleaned.replace(/~~/g, '');
                cleaned = cleaned.replace(/~/g, '');
                
                // 6. Remove links [text](url) -> text
                cleaned = cleaned.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1');
                
                // 7. Remove images ![alt](url) -> alt
                cleaned = cleaned.replace(/!\[([^\]]+)\]\([^\)]+\)/g, '$1');
                
                // 8. Remove remaining brackets and parentheses
                cleaned = cleaned.replace(/\[/g, '');
                cleaned = cleaned.replace(/\]/g, '');
                cleaned = cleaned.replace(/\(/g, '');
                cleaned = cleaned.replace(/\)/g, '');
                
                // 9. Remove blockquotes
                cleaned = cleaned.replace(/^>\s+/gm, '');
                cleaned = cleaned.replace(/>/g, '');
                
                // 10. Remove horizontal rules
                cleaned = cleaned.replace(/^[\-]{3,}$/gm, '');
                
                // 11. Remove list markers at start of lines
                cleaned = cleaned.replace(/^\d+\.\s+/gm, '');
                cleaned = cleaned.replace(/^[\-\+]\s+/gm, '');
                
                // 12. Clean up whitespace
                cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
                cleaned = cleaned.replace(/  +/g, ' ');
                
                return cleaned.trim();
            }

            getCSRFToken() {
                const name = 'csrftoken';
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            showAnalysisError(errorMessage) {
                // Display error in AI response area
                if (this.aiResponse) {
                    this.aiResponse.innerHTML = `
                        <div style="background: rgba(255,100,100,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <h5><i class="fas fa-exclamation-triangle"></i> Lỗi phân tích:</h5>
                            <p style="color: #ff6b6b;">${errorMessage}</p>
                            <p><em>Đang chuyển về chế độ demo...</em></p>
                        </div>
                    `;
                }
                
                // Simulate demo analysis after error
                setTimeout(() => this.simulateDocumentAnalysis(), 2000);
            }

            simulateDocumentAnalysis() {
                const demoData = {
                    response: "Đây là phân tích demo cho tài liệu bạn đã upload.\n\nThông tin file:\n- Tên: " + (this.currentFile ? this.currentFile.name : "unknown") + "\n- Kích thước: " + (this.currentFile ? this.formatFileSize(this.currentFile.size) : "unknown") + "\n\nĐể có phân tích chính xác nội dung file, vui lòng cấu hình API key cho các dịch vụ AI (Google Gemini hoặc OpenAI GPT).",
                    message: "Demo analysis completed"
                };
                
                this.displayAnalysisResult(demoData);
                this.showNotification('Đã hiển thị kết quả demo!');
            }

            copyAnalysisResult() {
                const resultElement = document.getElementById('analysisResult');
                const textContent = resultElement.innerText;
                
                navigator.clipboard.writeText(textContent).then(() => {
                    this.showNotification('Đã sao chép kết quả phân tích!');
                }).catch(() => {
                    this.showNotification('Lỗi khi sao chép!', 'error');
                });
            }

            askQuestionAboutDocument() {
                const question = prompt("Nhập câu hỏi về tài liệu:");
                if (question && question.trim()) {
                    const fullQuestion = `Dựa vào tài liệu đã phân tích, ${question}`;
                    this.editArea.value = fullQuestion;
                    this.sendQuestionToAI();
                }
            }

            clearFile() {
                this.currentFile = null;
                this.fileInput.value = '';
                
                // Reset button label
                const fileButtonLabel = document.getElementById('fileButtonLabel');
                if (fileButtonLabel) {
                    fileButtonLabel.textContent = 'Chọn file';
                }
                
                // Hide file info
                if (this.fileInfo) {
                    this.fileInfo.style.display = 'none';
                }
                
                // Disable analyze button
                if (this.analyzeFileBtn) {
                    this.analyzeFileBtn.disabled = true;
                    this.analyzeFileBtn.style.opacity = '0.5';
                }
                
                this.showNotification('Đã xóa file!');
            }

            initHistory() {
                // Initialize chat history from localStorage
                this.chatHistory = JSON.parse(localStorage.getItem('aiChatHistory') || '[]');
                console.log('Chat history loaded:', this.chatHistory.length, 'items');
                
                // Bind history button
                const historyBtn = document.getElementById('historyBtn');
                if (historyBtn) {
                    historyBtn.addEventListener('click', () => this.openHistory());
                }
            }

            openHistory() {
                const modal = document.getElementById('historyModal');
                if (modal) {
                    modal.style.display = 'flex';
                    this.displayHistory();
                }
            }

            displayHistory() {
                const historyList = document.getElementById('historyList');
                
                if (!this.chatHistory || this.chatHistory.length === 0) {
                    historyList.innerHTML = `
                        <p style="text-align: center; color: #6c757d; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 3em; display: block; margin-bottom: 10px; opacity: 0.3;"></i>
                            Chưa có lịch sử trò chuyện
                        </p>
                    `;
                    return;
                }
                
                historyList.innerHTML = this.chatHistory.map((item, index) => `
                    <div class="history-item">
                        <div class="history-item-header">
                            <span class="history-item-type">${this.getTypeLabel(item.type)}</span>
                            <span class="history-item-time">
                                <i class="fas fa-clock"></i> ${item.date || 'N/A'} ${item.time || ''}
                            </span>
                        </div>
                        <div class="history-item-question">
                            <i class="fas fa-comment"></i> ${this.escapeHtml(item.question)}
                        </div>
                        <div class="history-item-answer">
                            <i class="fas fa-robot"></i> ${this.escapeHtml(item.answer)}
                        </div>
                        <div class="history-item-actions">
                            <button onclick="app.viewHistoryDetail(${index})">
                                <i class="fas fa-eye"></i> Xem chi tiết
                            </button>
                            <button onclick="app.copyHistoryItem(${index})">
                                <i class="fas fa-copy"></i> Sao chép
                            </button>
                            <button onclick="app.deleteHistoryItem(${index})">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            getTypeLabel(type) {
                const labels = {
                    'question': '❓ Câu hỏi',
                    'translate': '🌐 Dịch thuật',
                    'summarize': '📝 Tóm tắt',
                    'improve': '✨ Cải thiện',
                    'punctuation': '✏️ Chấm câu'
                };
                return labels[type] || '💬 Trò chuyện';
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            saveToHistory(question, answer, type) {
                const historyItem = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    question: question.substring(0, 500), // Limit length
                    answer: answer.substring(0, 1000),
                    type: type,
                    date: new Date().toLocaleDateString('vi-VN'),
                    time: new Date().toLocaleTimeString('vi-VN')
                };
                
                this.chatHistory.unshift(historyItem); // Add to beginning
                
                // Limit to 50 items
                if (this.chatHistory.length > 50) {
                    this.chatHistory = this.chatHistory.slice(0, 50);
                }
                
                localStorage.setItem('aiChatHistory', JSON.stringify(this.chatHistory));
                console.log('History saved:', historyItem);
            }

            viewHistoryDetail(index) {
                const item = this.chatHistory[index];
                if (!item) return;
                
                // Close history modal
                document.getElementById('historyModal').style.display = 'none';
                
                // Display in AI response area
                this.aiResponse.innerHTML = `
                    <h4><i class="fas fa-history"></i> Lịch sử: ${this.getTypeLabel(item.type)}</h4>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <p style="color: #90caf9;"><strong>Thời gian:</strong> ${item.date} ${item.time}</p>
                        <p style="margin-top: 10px;"><strong>Câu hỏi:</strong></p>
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin: 5px 0; white-space: pre-wrap;">
                            ${this.escapeHtml(item.question)}
                        </div>
                        <p style="margin-top: 10px;"><strong>Phản hồi:</strong></p>
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin: 5px 0; white-space: pre-wrap;">
                            ${this.escapeHtml(item.answer)}
                        </div>
                    </div>
                `;
                
                // Scroll to AI response
                this.aiResponse.scrollIntoView({ behavior: 'smooth', block: 'center' });
                this.showNotification('Đã tải lại cuộc trò chuyện!');
            }

            copyHistoryItem(index) {
                const item = this.chatHistory[index];
                if (!item) return;
                
                const textToCopy = `Câu hỏi: ${item.question}\n\nPhản hồi AI: ${item.answer}`;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    this.showNotification('Đã sao chép nội dung!');
                }).catch(() => {
                    this.showNotification('Lỗi khi sao chép!', 'error');
                });
            }

            deleteHistoryItem(index) {
                if (!confirm('Bạn có chắc muốn xóa mục này?')) return;
                
                this.chatHistory.splice(index, 1);
                localStorage.setItem('aiChatHistory', JSON.stringify(this.chatHistory));
                this.displayHistory();
                this.showNotification('Đã xóa mục khỏi lịch sử!');
            }

            initSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = this.languageSelect.value;
                    
                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.startTime = Date.now(); // Add start time tracking
                        this.updateStatus('listening', 'Đang nghe...', 'fas fa-microphone');
                        this.startBtn.disabled = true;
                        this.stopBtn.disabled = false;
                        this.startBtn.classList.add('recording');
                    };
                    
                    this.recognition.onresult = (event) => {
                        let interimTranscript = '';
                        let finalTranscript = this.transcript;
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            let transcript = event.results[i][0].transcript;
                            
                            // KHÔNG tự động thêm dấu câu trong quá trình ghi âm
                            // Chỉ làm sạch văn bản cơ bản
                            transcript = transcript.trim();
                            
                            // Check for voice commands
                            if (this.processVoiceCommands(transcript)) {
                                continue;
                            }
                            
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript + ' ';
                            } else {
                                interimTranscript += transcript;
                            }
                        }
                        
                        this.transcript = finalTranscript;
                        this.transcriptArea.value = finalTranscript + interimTranscript;
                        this.editArea.value = this.transcriptArea.value;
                        this.updateWordCount();
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.updateStatus('error', 'Lỗi: ' + event.error, 'fas fa-exclamation-triangle');
                        this.showNotification('Lỗi nhận dạng giọng nói: ' + event.error, 'error');
                    };
                    
                    this.recognition.onend = () => {
                        this.isListening = false;
                        this.updateStatus('ready', 'Sẵn sàng', 'fas fa-circle');
                        this.startBtn.disabled = false;
                        this.stopBtn.disabled = true;
                        this.startBtn.classList.remove('recording');
                    };
                } else {
                    this.showNotification('Trình duyệt của bạn không hỗ trợ nhận dạng giọng nói!', 'error');
                }
            }

            bindEvents() {
                console.log('Binding events...');
                try {
                    this.startBtn.addEventListener('click', () => this.startListening());
                    this.stopBtn.addEventListener('click', () => this.stopListening());
                    this.clearBtn.addEventListener('click', () => this.clearAll());
                    this.copyBtn.addEventListener('click', () => this.copyText());
                    
                    // Save and Share buttons in Edit Area
                    const saveFileBtn = document.getElementById('saveFileBtn');
                    const shareBtnEdit = document.getElementById('shareBtn');
                    if (saveFileBtn) saveFileBtn.addEventListener('click', () => this.saveToFile());
                    if (shareBtnEdit) shareBtnEdit.addEventListener('click', () => this.shareText());
                    
                    // Original save/share buttons in features modal (if exists)
                    const settingsBtn = document.getElementById('settingsBtn');
                    if (settingsBtn) settingsBtn.addEventListener('click', () => this.openSettings());
                    
                    // Speech engine and language change handlers
                    if (this.speechEngine) {
                        this.speechEngine.addEventListener('change', () => {
                            this.currentEngine = this.speechEngine.value;
                            if (this.currentEngine === 'whisper') {
                                const confirmed = confirm(
                                    '⚠️ OpenAI Whisper API:\n\n' +
                                    '💰 Chi phí: $0.006/phút ($0.36/giờ)\n' +
                                    '🎯 Chất lượng: Cao hơn Web Speech API\n' +
                                    '⏱️ Tốc độ: Chậm hơn (2-3 giây delay)\n\n' +
                                    'Bạn có muốn tiếp tục không?'
                                );
                                
                                if (!confirmed) {
                                    this.speechEngine.value = 'browser';
                                    this.currentEngine = 'browser';
                                    this.showNotification('Đã quay về Web Speech API miễn phí!');
                                    return;
                                }
                                
                                this.showNotification('🎤 Đã chuyển sang OpenAI Whisper (có phí)!', 'warning');
                            } else {
                                this.showNotification('🆓 Đã chuyển sang Web Speech API (miễn phí)!');
                            }
                        });
                    }

                    if (this.languageSelect) {
                        this.languageSelect.addEventListener('change', () => {
                            if (this.recognition && this.currentEngine === 'browser') {
                                const browserLangMap = {
                                    'vi': 'vi-VN', 'en': 'en-US', 'ja': 'ja-JP', 
                                    'ko': 'ko-KR', 'zh': 'zh-CN', 'fr': 'fr-FR',
                                    'de': 'de-DE', 'es': 'es-ES'
                                };
                                this.recognition.lang = browserLangMap[this.languageSelect.value] || 'vi-VN';
                            }
                        });
                    }
                    
                    if (this.transcriptArea) {
                        this.transcriptArea.addEventListener('input', () => {
                            if (this.editArea) this.editArea.value = this.transcriptArea.value;
                            this.updateWordCount();
                        });
                    }
                    
                    if (this.editArea) {
                        this.editArea.addEventListener('input', () => {
                            this.updateWordCount();
                        });
                    }
                    
                    // AI Functions
                    if (this.sendToAI) this.sendToAI.addEventListener('click', () => this.sendQuestionToAI());
                    if (this.translateBtn) this.translateBtn.addEventListener('click', () => this.translateText());
                    if (this.summarizeBtn) this.summarizeBtn.addEventListener('click', () => this.summarizeText());
                    if (this.improveBtn) this.improveBtn.addEventListener('click', () => this.improveText());
                    
                    const aiPunctuationBtn = document.getElementById('aiPunctuationBtn');
                    if (aiPunctuationBtn) aiPunctuationBtn.addEventListener('click', () => this.aiFixPunctuation());
                    
                    console.log('Events bound successfully');
                } catch (error) {
                    console.error('Error binding events:', error);
                }
            }

            async startListening() {
                if (this.currentEngine === 'whisper') {
                    await this.startWhisperRecording();
                } else {
                    // Browser Speech API
                    if (this.recognition && !this.isListening) {
                        try {
                            this.recognition.start();
                        } catch (error) {
                            console.error('Error starting recognition:', error);
                            this.showNotification('Lỗi khi khởi động nhận dạng giọng nói!', 'error');
                        }
                    } else if (!this.recognition) {
                        this.showNotification('Trình duyệt không hỗ trợ nhận dạng giọng nói!', 'error');
                    }
                }
            }

            async startWhisperRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];

                    this.mediaRecorder.ondataavailable = (event) => {
                        this.audioChunks.push(event.data);
                    };

                    this.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                        await this.sendToWhisper(audioBlob);
                        
                        // Stop all tracks to release microphone
                        stream.getTracks().forEach(track => track.stop());
                    };

                    this.mediaRecorder.start();
                    this.isListening = true;
                    this.startTime = Date.now();
                    this.updateStatus('listening', 'Đang ghi âm với Whisper...', 'fas fa-microphone');
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.startBtn.classList.add('recording');

                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    this.showNotification('Không thể truy cập microphone!', 'error');
                }
            }

            async sendToWhisper(audioBlob) {
                this.updateStatus('processing', 'Đang xử lý với Whisper...', 'fas fa-cog');

                try {
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'recording.wav');
                    formData.append('language', this.languageSelect.value);

                    const response = await fetch('/whisper-transcribe/', {
                        method: 'POST',
                        body: formData,
                        timeout: 30000  // 30 second timeout
                    });

                    const data = await response.json();

                    // Handle both success and demo mode
                    if (data.transcription) {
                        const newText = data.transcription;
                        this.transcript += newText + ' ';
                        this.transcriptArea.value = this.transcript;
                        this.editArea.value = this.transcript;
                        this.updateWordCount();

                        // Different notifications based on engine
                        if (data.engine && data.engine.includes('Demo')) {
                            this.showNotification(`${data.engine}: ${newText.substring(0, 50)}...`, 'warning');
                        } else {
                            this.showNotification(`✅ Whisper: Nhận dạng thành công!`);
                        }
                    } else if (data.error) {
                        // If there's an error, show it but don't break the flow
                        this.showNotification(`⚠️ ${data.error}`, 'error');
                        
                        // Add demo text as fallback
                        const demoText = `[Demo] Bạn đã ghi âm bằng ${this.languageSelect.value}. `;
                        this.transcript += demoText;
                        this.transcriptArea.value = this.transcript;
                        this.editArea.value = this.transcript;
                        this.updateWordCount();
                    }

                } catch (error) {
                    console.error('Whisper network error:', error);
                    
                    // Network or server error - provide graceful fallback
                    const fallbackText = `[Demo] Ghi âm hoàn thành (${new Date().toLocaleTimeString()}). Whisper API không khả dụng. `;
                    this.transcript += fallbackText;
                    this.transcriptArea.value = this.transcript;
                    this.editArea.value = this.transcript;
                    this.updateWordCount();
                    
                    this.showNotification(`🔄 Dùng chế độ demo thay thế`, 'warning');
                }

                this.updateStatus('ready', 'Sẵn sàng', 'fas fa-circle');
            }

            stopListening() {
                if (this.currentEngine === 'whisper') {
                    if (this.mediaRecorder && this.isListening) {
                        this.mediaRecorder.stop();
                        this.isListening = false;
                        this.startBtn.disabled = false;
                        this.stopBtn.disabled = true;
                        this.startBtn.classList.remove('recording');
                    }
                } else {
                    if (this.recognition && this.isListening) {
                        this.recognition.stop();
                    }
                }
            }

            clearAll() {
                this.transcript = '';
                this.transcriptArea.value = '';
                this.editArea.value = '';
                this.aiResponse.innerHTML = '<p><i class="fas fa-info-circle"></i> Kết quả từ AI sẽ hiển thị ở đây...</p>';
                this.updateWordCount();
                this.showNotification('Đã xóa tất cả nội dung!');
            }

            copyText() {
                const textToCopy = this.editArea.value || this.transcriptArea.value;
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        this.showNotification('Đã sao chép văn bản!');
                    }).catch(() => {
                        this.showNotification('Lỗi khi sao chép văn bản!', 'error');
                    });
                } else {
                    this.showNotification('Không có văn bản để sao chép!', 'error');
                }
            }

            updateStatus(type, message, icon) {
                this.statusIndicator.className = `status-indicator ${type}`;
                this.statusIndicator.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;
            }

            updateWordCount() {
                const text = this.editArea.value || this.transcriptArea.value;
                const words = text.trim() ? text.trim().split(/\s+/).length : 0;
                const chars = text.length;
                
                this.wordCount.textContent = `${words} từ`;
                document.getElementById('charCount').textContent = `${chars} ký tự`;
                
                // Calculate WPM if recording
                if (this.isListening && this.startTime) {
                    const elapsedMinutes = (Date.now() - this.startTime) / 60000;
                    const wpm = elapsedMinutes > 0 ? Math.round(words / elapsedMinutes) : 0;
                    document.getElementById('wpm').textContent = `${wpm} từ/phút`;
                    
                    const elapsedSeconds = Math.round((Date.now() - this.startTime) / 1000);
                    document.getElementById('speechTime').textContent = `Thời gian: ${elapsedSeconds}s`;
                }
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.style.backgroundColor = type === 'error' ? '#dc3545' : '#28a745';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            // AI Functions
            async sendQuestionToAI() {
                const text = this.editArea.value || this.transcriptArea.value;
                if (!text.trim()) {
                    this.showNotification('Vui lòng nhập hoặc ghi âm nội dung trước!', 'error');
                    return;
                }

                this.showAILoading('Đang gửi câu hỏi cho AI...');
                await this.callRealAI(text, 'question');
            }

            async translateText() {
                const text = this.editArea.value || this.transcriptArea.value;
                if (!text.trim()) {
                    this.showNotification('Vui lòng nhập nội dung cần dịch!', 'error');
                    return;
                }

                this.showAILoading('Đang dịch văn bản...');
                await this.callRealAI(text, 'translate');
            }

            async summarizeText() {
                const text = this.editArea.value || this.transcriptArea.value;
                if (!text.trim()) {
                    this.showNotification('Vui lòng nhập nội dung cần tóm tắt!', 'error');
                    return;
                }

                this.showAILoading('Đang tóm tắt nội dung...');
                await this.callRealAI(text, 'summarize');
            }

            async improveText() {
                const text = this.editArea.value || this.transcriptArea.value;
                if (!text.trim()) {
                    this.showNotification('Vui lòng nhập nội dung cần cải thiện!', 'error');
                    return;
                }

                this.showAILoading('Đang cải thiện văn bản...');
                await this.callRealAI(text, 'improve');
            }

            async aiFixPunctuation() {
                const text = this.editArea.value || this.transcriptArea.value;
                if (!text.trim()) {
                    this.showNotification('Vui lòng nhập nội dung cần sửa chấm câu!', 'error');
                    return;
                }

                this.showAILoading('AI đang sửa chấm câu...');
                
                try {
                    const response = await fetch('/ai-chat/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: text,
                            type: 'punctuation'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Áp dụng kết quả sửa chấm câu trực tiếp vào văn bản
                    const fixedText = this.removeMarkdownSyntax(data.response.trim());
                    this.editArea.value = fixedText;
                    this.transcriptArea.value = fixedText;
                    this.transcript = fixedText;
                    this.updateWordCount();

                    this.aiResponse.innerHTML = `
                        <h4><i class="fas fa-check-circle"></i> AI đã sửa chấm câu:</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p><strong>Văn bản gốc:</strong> ${text.substring(0, 100)}${text.length > 100 ? '...' : ''}</p>
                            <p><strong>Sau khi sửa:</strong></p>
                            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin: 10px 0; line-height: 1.6; white-space: pre-wrap;">
                                ${fixedText}
                            </div>
                            <p style="color: #90EE90;">✅ Đã áp dụng vào văn bản chỉnh sửa!</p>
                        </div>
                    `;
                    
                    this.showNotification('✅ AI đã sửa chấm câu và áp dụng!');
                    
                } catch (error) {
                    console.error('AI Punctuation Error:', error);
                    
                    // Fallback to local punctuation fix
                    const localFixed = this.removeMarkdownSyntax(this.addAutoPunctuation(text));
                    this.editArea.value = localFixed;
                    this.transcriptArea.value = localFixed;
                    this.transcript = localFixed;
                    this.updateWordCount();
                    
                    this.aiResponse.innerHTML = `
                        <h4><i class="fas fa-exclamation-triangle"></i> Lỗi AI - Dùng sửa chấm câu cục bộ:</h4>
                        <div style="background: rgba(255,100,100,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p style="color: #ff6b6b;">Lỗi: ${error.message}</p>
                            <p><strong>Kết quả sửa cục bộ:</strong></p>
                            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin: 10px 0; white-space: pre-wrap;">
                                ${localFixed}
                            </div>
                            <p>✅ Đã áp dụng kết quả sửa cục bộ!</p>
                        </div>
                    `;
                    
                    this.showNotification('⚠️ Dùng sửa chấm câu cục bộ thay thế!', 'warning');
                }
            }

            showAILoading(message) {
                this.aiResponse.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="loading"></div>
                        <span>${message}</span>
                    </div>
                `;
            }

            async callRealAI(text, type) {
                try {
                    const response = await fetch('/ai-chat/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: text,
                            type: type
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Hiển thị phản hồi từ AI thật
                    const cleanResponse = this.removeMarkdownSyntax(data.response);
                    this.aiResponse.innerHTML = `
                        <h4><i class="fas fa-robot"></i> Phản hồi từ OpenAI GPT:</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p><strong>Loại xử lý:</strong> ${this.getActionTypeText(type)}</p>
                            <p><strong>Phản hồi:</strong></p>
                            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin: 10px 0; line-height: 1.6; white-space: pre-wrap;">
                                ${cleanResponse}
                            </div>
                        </div>
                    `;
                    
                    // Save to history
                    this.saveToHistory(text, cleanResponse, type);
                    
                    this.showNotification('AI đã xử lý thành công!');
                    
                } catch (error) {
                    console.error('AI Error:', error);
                    this.aiResponse.innerHTML = `
                        <h4><i class="fas fa-exclamation-triangle"></i> Lỗi AI:</h4>
                        <div style="background: rgba(255,100,100,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p style="color: #ff6b6b;">${error.message}</p>
                            <p><em>Đang chuyển về chế độ demo...</em></p>
                        </div>
                    `;
                    
                    // Fallback to demo mode
                    await this.simulateAIResponse(text, type);
                }
            }

            getActionTypeText(type) {
                const types = {
                    'question': 'Trả lời câu hỏi',
                    'translate': 'Dịch thuật', 
                    'summarize': 'Tóm tắt nội dung',
                    'improve': 'Cải thiện văn bản',
                    'punctuation': 'Sửa chấm câu'
                };
                return types[type] || 'Xử lý AI';
            }

            addAutoPunctuation(text) {
                if (!text || typeof text !== 'string') return text;
                
                let processedText = text.trim();
                
                // 1. Xóa các dấu câu thừa và khoảng trắng
                processedText = processedText
                    .replace(/\s+/g, ' ')  // Chuẩn hóa khoảng trắng
                    .replace(/\s+(\.|\?|\!|,|;|:)/g, '$1')  // Xóa khoảng trắng trước dấu câu
                    .replace(/([\.!\?])\s*([\.!\?])+/g, '$1')  // Xóa dấu câu trùng lặp
                    .replace(/\.{2,}/g, '.')  // Xóa dấu chấm liên tiếp (2 hoặc nhiều hơn)
                    .replace(/,,+/g, ',');  // Xóa dấu phẩy trùng lặp

                // 2. KHÔNG tự động thêm dấu câu cho từng câu ngắn
                // Chỉ chuẩn hóa các dấu câu đã có

                // 3. Viết hoa chữ cái đầu văn bản
                processedText = processedText
                    .replace(/^([a-zA-ZÀ-ỹ])/, (match) => match.toUpperCase());

                // 4. Viết hoa sau dấu câu kết thúc (nếu có)
                processedText = processedText
                    .replace(/([\.!\?])\s+([a-zA-ZÀ-ỹ])/g, (match, punct, letter) => punct + ' ' + letter.toUpperCase());

                // 5. Làm sạch kết quả cuối cùng
                processedText = processedText
                    .replace(/\s+([\.!\?,;:])/g, '$1')  // Xóa khoảng trắng trước dấu câu
                    .replace(/([\.!\?])\s+/g, '$1 ')    // Chuẩn hóa khoảng trắng sau dấu câu
                    .replace(/\s+/g, ' ')               // Chuẩn hóa khoảng trắng
                    .trim();

                // 6. CHỈ thêm dấu chấm cuối nếu văn bản dài và chưa có dấu câu
                if (processedText.length > 20 && !/[\.!\?]$/.test(processedText)) {
                    // Kiểm tra xem có phải câu hỏi không
                    if (/\b(ai|gì|đâu|khi nào|thế nào|tại sao|vì sao|bao nhiêu|có phải không|sao)\b/gi.test(processedText)) {
                        processedText += '?';
                    } else {
                        processedText += '.';
                    }
                }

                return processedText;
            }

            processVoiceCommands(text) {
                const lowerText = text.toLowerCase().trim();
                
                // Voice commands
                if (lowerText.includes('gửi cho ai') || lowerText.includes('hỏi ai')) {
                    setTimeout(() => this.sendQuestionToAI(), 500);
                    return true;
                }
                
                if (lowerText.includes('dịch sang tiếng anh') || lowerText.includes('dịch ra tiếng anh')) {
                    setTimeout(() => this.translateText(), 500);
                    return true;
                }
                
                if (lowerText.includes('tóm tắt') || lowerText.includes('tóm tắt nội dung')) {
                    setTimeout(() => this.summarizeText(), 500);
                    return true;
                }
                
                if (lowerText.includes('cải thiện') || lowerText.includes('sửa văn bản')) {
                    setTimeout(() => this.improveText(), 500);
                    return true;
                }
                
                if (lowerText.includes('xóa tất cả') || lowerText.includes('xóa hết')) {
                    setTimeout(() => this.clearAll(), 500);
                    return true;
                }
                
                return false;
            }

            async simulateAIResponse(text, type) {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const responses = {
                    'question': `
                        <h4><i class="fas fa-robot"></i> Phản hồi từ AI:</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p><strong>Câu hỏi của bạn:</strong> "${text.substring(0, 100)}${text.length > 100 ? '...' : ''}"</p>
                            <p><strong>Trả lời:</strong> Tôi đã hiểu câu hỏi của bạn. Đây là một phản hồi mẫu từ hệ thống AI. 
                            Để có phản hồi thông minh hơn, bạn cần tích hợp với các API AI như OpenAI GPT, Google Gemini, hoặc Claude.</p>
                            <p><strong>Gợi ý phát triển:</strong></p>
                            <ul style="margin-left: 20px; color: rgba(255,255,255,0.9);">
                                <li>Tích hợp OpenAI API</li>
                                <li>Sử dụng Google AI Platform</li>
                                <li>Tích hợp với Anthropic Claude</li>
                            </ul>
                        </div>
                    `,
                    'translate': `
                        <h4><i class="fas fa-language"></i> Bản dịch tiếng Anh:</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p><strong>Văn bản gốc:</strong> ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}</p>
                            <p><strong>Bản dịch mẫu:</strong> <em>This is a simulated English translation. For accurate translation, integrate with Google Translate API or similar services.</em></p>
                        </div>
                    `,
                    'summarize': `
                        <h4><i class="fas fa-compress-alt"></i> Tóm tắt nội dung:</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p><strong>Độ dài:</strong> ${text.length} ký tự</p>
                            <p><strong>Tóm tắt:</strong> Đây là phần tóm tắt các ý chính từ văn bản của bạn. 
                            Nội dung đã được rút gọn và tập trung vào những điểm quan trọng nhất.</p>
                        </div>
                    `,
                    'improve': `
                        <h4><i class="fas fa-magic"></i> Văn bản đã cải thiện:</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p><strong>Văn bản cải thiện:</strong></p>
                            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <em>${text.length > 100 ? text.substring(0, 100) + '...' : text}</em>
                            </div>
                            <p><strong>Đã cải thiện:</strong> Ngữ pháp, cấu trúc câu và từ vựng</p>
                        </div>
                        <button class="btn btn-success" onclick="app.applyImprovedText('${text}')">
                            <i class="fas fa-check"></i> Áp dụng văn bản cải thiện
                        </button>
                    `
                };
                
                this.aiResponse.innerHTML = responses[type] || responses['question'];
                this.showNotification('AI đã xử lý xong yêu cầu của bạn!');
            }

            applyImprovedText(improvedText) {
                this.editArea.value = improvedText + ' (đã cải thiện)';
                this.updateWordCount();
                this.showNotification('Đã áp dụng văn bản cải thiện!');
            }

            saveToFile() {
                const text = this.editArea.value || this.transcriptArea.value;
                if (!text.trim()) {
                    this.showNotification('Không có nội dung để lưu!', 'error');
                    return;
                }
                
                const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `speech-to-text-${new Date().toISOString().split('T')[0]}.txt`;
                link.click();
                
                this.showNotification('Đã lưu file thành công!');
            }

            shareText() {
                const text = this.editArea.value || this.transcriptArea.value;
                if (!text.trim()) {
                    this.showNotification('Không có nội dung để chia sẻ!', 'error');
                    return;
                }
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Văn bản Speech-to-Text',
                        text: text
                    }).then(() => {
                        this.showNotification('Đã chia sẻ thành công!');
                    }).catch(() => {
                        this.copyText(); // Fallback to copy
                    });
                } else {
                    this.copyText(); // Fallback for browsers without Web Share API
                }
            }

            fixPunctuation() {
                const text = this.editArea.value || this.transcriptArea.value;
                if (!text.trim()) {
                    this.showNotification('Không có văn bản để sửa chấm câu!', 'error');
                    return;
                }

                const originalText = text;
                const fixedText = this.addAutoPunctuation(text);
                
                if (originalText !== fixedText) {
                    this.editArea.value = fixedText;
                    this.transcriptArea.value = fixedText;
                    this.transcript = fixedText;
                    this.updateWordCount();
                    this.showNotification('✅ Đã sửa chấm câu và viết hoa!');
                } else {
                    this.showNotification('ℹ️ Văn bản đã có chấm câu đúng rồi!');
                }
            }

            openSettings() {
                console.log('Opening settings modal...');
                document.getElementById('settingsModal').style.display = 'flex';
            }
        }

        // Global functions for modals
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function clearAllHistory() {
            if (!confirm('Bạn có chắc muốn xóa toàn bộ lịch sử trò chuyện?')) return;
            
            if (app) {
                app.chatHistory = [];
                localStorage.setItem('aiChatHistory', JSON.stringify(app.chatHistory));
                app.displayHistory();
                app.showNotification('Đã xóa toàn bộ lịch sử!');
            }
        }

        function exportHistory() {
            if (!app || !app.chatHistory || app.chatHistory.length === 0) {
                alert('Không có lịch sử để xuất!');
                return;
            }
            
            let exportText = '=== LỊCH SỬ TRÒ CHUYỆN VỚI AI ===\n\n';
            exportText += `Xuất ngày: ${new Date().toLocaleDateString('vi-VN')} ${new Date().toLocaleTimeString('vi-VN')}\n`;
            exportText += `Tổng số: ${app.chatHistory.length} cuộc trò chuyện\n\n`;
            exportText += '='.repeat(60) + '\n\n';
            
            app.chatHistory.forEach((item, index) => {
                exportText += `${index + 1}. ${app.getTypeLabel(item.type)}\n`;
                exportText += `Thời gian: ${item.date} ${item.time}\n`;
                exportText += `\nCâu hỏi:\n${item.question}\n`;
                exportText += `\nPhản hồi:\n${item.answer}\n`;
                exportText += '\n' + '='.repeat(60) + '\n\n';
            });
            
            const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `lich-su-tro-chuyen-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            
            app.showNotification('Đã xuất lịch sử ra file!');
        }

        function saveSettings() {
            const settings = {
                speechQuality: document.getElementById('speechQuality').value,
                autoPunctuation: document.getElementById('autoPunctuation').checked,
                voiceCommands: document.getElementById('voiceCommands').checked,
                aiProvider: document.getElementById('aiProvider').value
            };
            
            localStorage.setItem('speechToTextSettings', JSON.stringify(settings));
            closeSettings();
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.backgroundColor = '#28a745';
            notification.textContent = 'Đã lưu cài đặt thành công!';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('speechToTextSettings') || '{}');
            
            if (settings.speechQuality) {
                document.getElementById('speechQuality').value = settings.speechQuality;
            }
            if (settings.autoPunctuation !== undefined) {
                document.getElementById('autoPunctuation').checked = settings.autoPunctuation;
            }
            if (settings.voiceCommands !== undefined) {
                document.getElementById('voiceCommands').checked = settings.voiceCommands;
            }
            if (settings.aiProvider) {
                document.getElementById('aiProvider').value = settings.aiProvider;
            }
        }

        // Initialize the app when the page loads
        let app;
        console.log('=== SETTING UP DOM LISTENER ===');
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== DOM LOADED - INITIALIZING APP ===');
            try {
                loadSettings(); // Load saved settings
                console.log('Settings loaded');
                app = new SpeechToTextApp();
                console.log('=== APP INITIALIZED SUCCESSFULLY ===');
                console.log('App instance:', app);
            } catch (error) {
                console.error('=== FATAL ERROR INITIALIZING APP ===', error);
                alert('LỖI NGHIÊM TRỌNG: ' + error.message + '\n\nMở Console (F12) để xem chi tiết.');
            }
        });
        
        console.log('=== JAVASCRIPT FILE END ===');
    </script>
</body>
</html>